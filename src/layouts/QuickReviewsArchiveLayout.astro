---
import Pagination from '@components/molecules/Pagination';
import QuickReviewCards from '@components/molecules/QuickReviewCards';
import ArchiveHero from '@components/organisms/ArchiveHero';
import metaConfig from '@public/cms/meta.yml';
import type { QuickReview } from '@schemas/quick-review';
import { QuickReviewType, QuickReviewRating } from '@schemas/quick-review-types';
import type { SiteMeta } from '@schemas/site-meta';
import { getTypeFromLowercaseKey, getRatingFromLowercaseKey } from '@schemas/quick-review-types';
import BaseLayout from './BaseLayout.astro';
const siteMeta: SiteMeta = metaConfig;

interface Props {
  reviews: QuickReview[];
  currentPage: number;
  totalPages: number;
  totalReviews: number;
  currentType?: string;
  currentRating?: string;
}

const { reviews, currentPage, totalPages, totalReviews, currentType: currentTypeParam, currentRating: currentRatingParam }: Props = Astro.props;

// Convert lowercase params to proper enum values
const currentType = currentTypeParam ? getTypeFromLowercaseKey(currentTypeParam) : undefined;
const currentRating = currentRatingParam ? getRatingFromLowercaseKey(currentRatingParam) : undefined;

const allTypes = Object.keys(QuickReviewType).map((key) => key);
const allRatings = Object.keys(QuickReviewRating).map((key) => key).reverse();

// { name: string; slug: string; url: string; active?: boolean }
const typeTags = allTypes.map((type) => {
  const typeValue = QuickReviewType[type as keyof typeof QuickReviewType];
  const isActive = typeValue === currentType;
  return {
    name: typeValue + 's',
    slug: type.toLowerCase(),
    url: isActive ? `/quick-reviews` : `/quick-reviews/type/${type.toLowerCase()}`,
    active: isActive,
  };
});

const ratingTags = allRatings.map((rating) => {
  const ratingValue = QuickReviewRating[rating as keyof typeof QuickReviewRating];
  const isActive = ratingValue === currentRating;
  return {
    name: ratingValue,
    slug: rating.toLowerCase(),
    url: isActive ? `/quick-reviews` : `/quick-reviews/rating/${rating.toLowerCase()}`,
    active: isActive,
  }
});

const tagGroups = [
  typeTags ? { label: 'Filter by media type:', tags: typeTags } : null,
  ratingTags ? { label: 'or filter by rating:', tags: ratingTags } : null,
].filter(a => a);

let paginationBaseUrl = '/quick-reviews';
if (currentType) paginationBaseUrl += `/type/${currentType.toLowerCase()}`;
if (currentRating) paginationBaseUrl += `/rating/${currentRating.toLowerCase()}`;

---

<BaseLayout
  title='Quick Reviews'
  image={siteMeta.baseUrl + '/cms/media/articles/quick-reviews-preview.png'}
  description="A special place to dump my unsolicited opinions of pieces of media!"
  hasHeaderBackground
>
  <div class='l-quick-reviews-archive'>
    <div class='l-quick-reviews-archive__container' data-pagefind-body>
      <ArchiveHero
        class='l-quick-reviews-archive__hero'
        title='Quick Reviews'
        body="Since June 2024, I started writing quick reviews of movies, TV shows and games I’ve watched or played. Here’s every one of them."
        tagGroups={tagGroups}
      />

      <div class='l-quick-reviews-archive__content-wrapper u-container'>
        <div class='u-container-small u-markdown'>
          <p>
            This idea and overall review layout were totally stolen from Matt Birchler and his <a
              href='https://quickreviews.app'
              target='_blank'
            >
              Quick Reviews
            </a> web app. Check it out if you want to create yours!
          </p>
        </div>

        {!reviews.length && <p class='u-h4'>No reviews found</p>}

        {
          totalReviews && (
            <p class='l-quick-reviews-archive__summary'>
              {totalReviews} reviews
              {currentType && ` for "${currentType}"`}
              {currentRating && ` rated "${currentRating}"`}
            </p>
          )
        }

        {
          // I'm passing reviews as a prop here to avoid having multiple
          // Elements with client:load. Having multiple islands like that
          // can cause issues.
          reviews && (            
            <QuickReviewCards reviews={reviews} client:load />
          )
        }

        {
          totalPages > 1 && (
            <Pagination
              class='l-quick-reviews-archive__pagination'
              currentPage={currentPage}
              totalPages={totalPages}
              baseUrl={paginationBaseUrl}
            />
          )
        }
      </div>
    </div>
  </div>
</BaseLayout>

<style lang='scss'>
  @use '/src/styles/breakpoints';
  @use '/src/styles/typography';

  :root:has(.l-quick-reviews-archive) {
    --theme--color-accent: var(--theme--color-quick-review);
    --theme--color-accent-rgb: var(--theme--color-quick-review-rgb);
    --theme--color-accent-contrast: var(--theme--color-quick-review-contrast);
    --theme--color-accent-shade: var(--theme--color-quick-review-shade);
    --theme--color-accent-tint: var(--theme--color-quick-review-tint);
    --theme--color-accent-glow: var(--theme--color-quick-review-glow);
  }

  .l-quick-reviews-archive {
    &__container {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xxl);

      @include breakpoints.for-phone-only {
        gap: var(--spacing-xl);
      }
    }

    &__content-wrapper {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-lg);
    }

    &__summary {
      text-align: center;
    }
  }
</style>
